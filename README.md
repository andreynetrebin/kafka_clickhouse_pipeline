# –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Kafka + ClickHouse

[![Docker](https://img.shields.io/badge/Docker-‚úì-blue)](https://docker.com)
[![Kafka](https://img.shields.io/badge/Kafka-‚úì-blue)](https://kafka.apache.org)
[![ClickHouse](https://img.shields.io/badge/ClickHouse-‚úì-blue)](https://clickhouse.com)
[![Real-time](https://img.shields.io/badge/Real--time-‚úì-green)](https://clickhouse.com)

–î–∞–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—é –ø–æ—Ç–æ–∫–æ–≤—ã—Ö ETL-–∫–æ–Ω–≤–µ–π–µ—Ä–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º **Apache Kafka** –≤
–∫–∞—á–µ—Å—Ç–≤–µ –±—Ä–æ–∫–µ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ **ClickHouse** –∫–∞–∫ –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–π –∫–æ–ª–æ–Ω–æ—á–Ω–æ–π –°–£–ë–î –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### –û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

```text
[Data Generator] ‚Üí [Kafka Topics] ‚Üí [Kafka Engine Tables] ‚Üí [Materialized Views] ‚Üí [Target Tables] ‚Üí [Web Dashboard]
```

### –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞

```text
Python App ‚Üí Kafka (sales topic) ‚Üí sales_kafka (Kafka Engine) ‚Üí sales_mv (MV) ‚Üí sales (MergeTree) ‚Üí Dashboard
Python App ‚Üí Kafka (warehouse topic) ‚Üí warehouse_kafka (Kafka Engine) ‚Üí stock_movements_mv (MV) ‚Üí stock_movements (MergeTree) ‚Üí Dashboard
```

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–æ–ø–∏–∫–∏ Kafka

- **`sales`** - –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–¥–∞–∂–∞—Ö (70% —Ç—Ä–∞—Ñ–∏–∫–∞)
- **`warehouse`** - –¥–≤–∏–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ (30% —Ç—Ä–∞—Ñ–∏–∫–∞)

### –¢–∞–±–ª–∏—Ü—ã ClickHouse

| –¢–∞–±–ª–∏—Ü–∞                  | –¢–∏–ø               | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                    |
|--------------------------|-------------------|-------------------------------|
| **`sales_kafka`**        | Kafka Engine      | –ü—Ä–∏–µ–º–Ω–∏–∫ –¥–ª—è —Ç–æ–ø–∏–∫–∞ sales     |
| **`warehouse_kafka`**    | Kafka Engine      | –ü—Ä–∏–µ–º–Ω–∏–∫ –¥–ª—è —Ç–æ–ø–∏–∫–∞ warehouse |
| **`sales_mv`**           | Materialized View | –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂   |
| **`stock_movements_mv`** | Materialized View | –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–≤–∏–∂–µ–Ω–∏–π —Å–∫–ª–∞–¥–∞ |
| **`sales`**              | MergeTree         | –§–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥–∞–∂       |
| **`stock_movements`**    | MergeTree         | –î–≤–∏–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤              |

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (3 —à–∞–≥–∞)

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- **Docker** & **Docker Compose**
- 4+ –ì–± –û–ó–£
- 2+ —è–¥—Ä–∞ CPU

### 1. –ó–∞–ø—É—Å–∫ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

```bash
# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫
git clone https://github.com/andreynetrebin/kafka_clickhouse_pipeline/
cd kafka_clickhouse_pipeline
docker-compose up -d
```

### 2. –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```bash
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ClickHouse
docker-compose exec clickhouse clickhouse-client

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–∏–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Kafka
ATTACH TABLE sales_kafka;
ATTACH TABLE warehouse_kafka;
```

### 3. –û—Ç–∫—Ä—ã—Ç–∏–µ –¥–∞—à–±–æ—Ä–¥–∞

```
–û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: http://localhost:3000
```

## ‚ö° –ú–µ—Ö–∞–Ω–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### 1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

```python
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è 1-2 —Å–æ–æ–±—â–µ–Ω–∏—è/—Å–µ–∫—É–Ω–¥—É
producer.send('sales', {
    'event_id': 'uuid',
    'event_time': '2024-01-15 10:00:00',
    'product_id': 123,
    'price': 100.50,
    'quantity': 2
})
```

### 2. Real-time –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Kafka Engine

```sql
-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –∏–∑ —Ç–æ–ø–∏–∫–æ–≤
CREATE TABLE sales_kafka (...) ENGINE = Kafka(
    kafka_broker_list = 'kafka:29092',
    kafka_topic_list = 'sales',
    kafka_format = 'JSONEachRow'
);
```

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è

```sql
-- Materialized Views –ø—Ä–µ–æ–±—Ä–∞–∑—É—é—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ –ª–µ—Ç—É
CREATE MATERIALIZED VIEW sales_mv TO sales AS
SELECT 
    parseDateTimeBestEffort(event_time) as event_time,
    toDecimal32(price, 2) as price,
    -- ... —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–ª–µ–π
FROM sales_kafka;
```

### 4. –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

```javascript
// –î–∞—à–±–æ—Ä–¥ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
setInterval(loadData, 5000); // Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
```

## üéØ –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ –ø—Ä–æ–µ–∫—Ç–µ

- **–ü–æ–ª–Ω—ã–π ETL-–∫–æ–Ω–≤–µ–π–µ—Ä** –≤ Docker-–æ–∫—Ä—É–∂–µ–Ω–∏–∏
- **Real-time –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ** –∏–∑ Kafka —Ç–æ–ø–∏–∫–æ–≤ (1-2 —Å–µ–∫ –∑–∞–¥–µ—Ä–∂–∫–∏)
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è** —á–µ—Ä–µ–∑ Materialized Views
- **–ì–æ—Ç–æ–≤—ã–π –¥–∞—à–±–æ—Ä–¥** —Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

## üé• –í–∏–¥–µ–æ-–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è

–ü—Ä–æ–µ–∫—Ç –≤–∫–ª—é—á–∞–µ—Ç –¥–µ–º–æ-–≤–∏–¥–µ–æ, –ø–æ–∫–∞–∑—ã–≤–∞—é—â–µ–µ:

- ‚úÖ –ó–∞–ø—É—Å–∫ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ 
- ‚úÖ –ê–∫—Ç–∏–≤–∞—Ü–∏—é –ø—Ä–∏–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Kafka –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ –†–∞–±–æ—Ç—É –¥–∞—à–±–æ—Ä–¥–∞ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—é —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –∏—Ö –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ

[**–°–º–æ—Ç—Ä–µ—Ç—å –¥–µ–º–æ-–≤–∏–¥–µ–æ**](https://disk.yandex.ru/i/gm4MXOuTgg_GOA)

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫:** Docker ¬∑ Kafka ¬∑ ClickHouse ¬∑ Python ¬∑ Flask ¬∑ Chart.js

**–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞:** ‚úÖ –†–∞–±–æ—á–∏–π –ø—Ä–æ—Ç–æ—Ç–∏–ø ¬∑ üöÄ –ì–æ—Ç–æ–≤ –∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ ¬∑ üìä Real-time analytics
