# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Kafka —Å ClickHouse

–î–∞–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—é –ø–æ—Ç–æ–∫–æ–≤—ã—Ö ETL-–∫–æ–Ω–≤–µ–π–µ—Ä–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Apache Kafka –≤ –∫–∞—á–µ—Å—Ç–≤–µ –±—Ä–æ–∫–µ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ ClickHouse –∫–∞–∫ –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–π –∫–æ–ª–æ–Ω–æ—á–Ω–æ–π –°–£–ë–î –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–¶–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞](#—Ü–µ–ª—å-–ø—Ä–æ–µ–∫—Ç–∞)
- [1. –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Kafka + ClickHouse](#1.-–ë–∞–∑–æ–≤–∞—è-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è-Kafka-+-ClickHouse)
- [1.1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è](#1.1.-–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Ä–µ—à–µ–Ω–∏—è)
- [1.2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö](#1.2.-–°—Ç—Ä—É–∫—Ç—É—Ä–∞-–¥–∞–Ω–Ω—ã—Ö)
- [1.3. –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](#1.3.-–ë—ã—Å—Ç—Ä—ã–π-—Å—Ç–∞—Ä—Ç)
- [1.4. –ú–µ—Ö–∞–Ω–∏–∫–∞ —Ä–∞–±–æ—Ç—ã](#1.4.-–ú–µ—Ö–∞–Ω–∏–∫–∞-—Ä–∞–±–æ—Ç—ã)
- [1.5 –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã](#1.5-–ö–ª—é—á–µ–≤—ã–µ-–≤—ã–≤–æ–¥—ã)
- [2. –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç–∏ Kafka –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö](#2.-–ê–Ω–∞–ª–∏–∑-–ø—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç–∏-Kafka-–¥–ª—è-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π-–¥–∞–Ω–Ω—ã—Ö)
- [2.1. –ü—Ä–æ–±–ª–µ–º–∞—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ –≤ ClickHouse](#2.1.-–ü—Ä–æ–±–ª–µ–º–∞—Ç–∏–∫–∞-—Ä–∞–±–æ—Ç—ã-—Å-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏-–≤-ClickHouse)
- [2.2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è —Å Kafka](#2.2.-–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ-—Ä–µ—à–µ–Ω–∏—è-—Å-Kafka)
- [2.3. –ë–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤](#2.3.-–ë–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∞-–¥–ª—è-–±–æ–ª—å—à–∏—Ö-–æ–±—ä–µ–º–æ–≤)
- [2.4. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è](#2.4.-–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ-—Å—Ü–µ–Ω–∞—Ä–∏–∏-–ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è)
- [2.5. –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã](#2.5.-–ö–ª—é—á–µ–≤—ã–µ-–≤—ã–≤–æ–¥—ã)


## –¶–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞

1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ:
–ë–∞–∑–æ–≤—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é Kafka + ClickHouse —Å —Ä–∞–∑–≤–µ—Ç—ã–≤–∞–Ω–∏–µ–º –≤ Docker-–æ–∫—Ä—É–∂–µ–Ω–∏–∏:
- Real-time –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Kafka —Ç–æ–ø–∏–∫–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–º–æ—â—å—é Materialized Views
- –°–æ–∑–¥–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ö—Ä–∞–Ω–∏–ª–∏—â –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

2. –ü—Ä–æ–≤–µ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑ –ø—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç–∏ Kafka –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:
- –ß–∞—Å—Ç—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö (—Ü–µ–Ω—ã, –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å)
- –û—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ (–º–∏–ª–ª–∏–æ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π/–¥–µ–Ω—å)
- CDC-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä —Å –±–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–æ–π


## 1. –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Kafka + ClickHouse    

## 1.1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è
–û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö
```text
[Data Generator] ‚Üí [Kafka Topics] ‚Üí [Kafka Engine Tables] ‚Üí [Materialized Views] ‚Üí [Target Tables]
```
–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞
```text
Python App ‚Üí Kafka (sales topic) ‚Üí sales_kafka (Kafka Engine) ‚Üí sales_mv (MV) ‚Üí sales (MergeTree)
Python App ‚Üí Kafka (warehouse topic) ‚Üí warehouse_kafka (Kafka Engine) ‚Üí stock_movements_mv (MV) ‚Üí stock_movements (MergeTree)
```
## 1.2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
–¢–æ–ø–∏–∫–∏ Kafka:
  - sales - –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–¥–∞–∂–∞—Ö (70% —Ç—Ä–∞—Ñ–∏–∫–∞)
  - warehouse - –¥–≤–∏–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ (30% —Ç—Ä–∞—Ñ–∏–∫–∞)

–¢–∞–±–ª–∏—Ü—ã —Å –¥–≤–∏–∂–∫–æ–º Kafka (–ø—Ä–∏–µ–º–Ω–∏–∫–∏):
  - sales_kafka - –ø—Ä–∏–µ–º–Ω–∏–∫ –¥–ª—è —Ç–æ–ø–∏–∫–∞ sales
  - warehouse_kafka - –ø—Ä–∏–µ–º–Ω–∏–∫ –¥–ª—è —Ç–æ–ø–∏–∫–∞ warehouse

–ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ—Ç —Ç–∞–±–ª–∏—Ü –ø—Ä–∏–µ–º–Ω–∏–∫–æ–≤ –≤ —Ü–µ–ª–µ–≤—ã–µ:
  - sales_mv  - —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ–¥–∞–∂
  - stock_movements_mv  - —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏–π —Å–∫–ª–∞–¥–∞

–¶–µ–ª–µ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã ClickHouse
  - sales - —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥–∞–∂ (MergeTree)
  - stock_movements - –¥–≤–∏–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ (MergeTree)

## 1.3. –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
  - Docker
  - Docker Compose
  - 4+ –ì–± –û–ó–£

### –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞
  ```bash
# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
git clone https://github.com/andreynetrebin/kafka_clickhouse_pipeline/
cd kafka_clickhouse_pipeline

# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker-compose up -d

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
docker-compose ps -a

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
docker-compose logs data-generator -f

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ ClickHouse
docker-compose logs clickhouse -f
  ```

## 1.4. –ú–µ—Ö–∞–Ω–∏–∫–∞ —Ä–∞–±–æ—Ç—ã
1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Å –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å—é —Å 0.5-1.5 —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
   ```python
    # Python-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ json-—Ñ–æ—Ä–º–∞—Ç–µ
    # –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–æ–ø–∏–∫–∏ Kafka
    producer.send('sales', sale_data)
    producer.send('warehouse', movement_data)
   ```
2. –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –∏–∑ Kafka
  ```sql
  -- –¢–∞–±–ª–∏—Ü—ã Kafka Engine –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è –∫ —Ç–æ–ø–∏–∫–∞–º
  CREATE TABLE sales_kafka (...) ENGINE = Kafka(
      kafka_broker_list = 'kafka:29092',
      kafka_topic_list = 'sales',
      kafka_group_name = 'clickhouse_sales_consumer',
      kafka_format = 'JSONEachRow',
      kafka_group_name = 'clickhouse_consumer'
  );
  ```  
3. –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è —á–µ—Ä–µ–∑ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (Materialized Views)
   ```sql
    -- MV –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É—é—Ç –∏ –ø–µ—Ä–µ–Ω–æ—Å—è—Ç –¥–∞–Ω–Ω—ã–µ
    CREATE MATERIALIZED VIEW sales_mv TO sales AS
    SELECT 
        event_id,
        parseDateTimeBestEffort(event_time) as event_time,
        -- ... –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –ø–æ–ª–µ–π
    FROM sales_kafka;
   ```
4.  –•—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö
   ```sql
    -- –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ MergeTree —Å –ø–∞—Ä—Ç–∏—Ü–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–æ –º–µ—Å—è—Ü–∞–º –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π
    CREATE TABLE sales (
        -- ...
    ) ENGINE = MergeTree()
    PARTITION BY toYYYYMM(event_time)
    ORDER BY (event_time, product_id);
   ```

## 1.5. –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã –ø–æ –±–∞–∑–æ–≤–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
‚úÖ –ß—Ç–æ —É—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:
  - –†–∞–±–æ—á–∏–π ETL-–∫–æ–Ω–≤–µ–π–µ—Ä –≤ Docker-–æ–∫—Ä—É–∂–µ–Ω–∏–∏
  - Real-time –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Kafka —Ç–æ–ø–∏–∫–æ–≤
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è —á–µ—Ä–µ–∑ Materialized Views
  - –ì–æ—Ç–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

–ò–¥–µ–∞–ª—å–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è –¥–∞–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:
```sql
-- –î–∞–Ω–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ append-only
-- –í—ã—Å–æ–∫–∏–µ –æ–±—ä–µ–º—ã –∑–∞–ø–∏—Å–∏ (50-100K+ —Å–æ–æ–±—â–µ–Ω–∏–π/—Å–µ–∫)
-- –¢—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∏ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏
-- –û—Å–Ω–æ–≤–Ω–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
```
–ö–æ–≥–¥–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –¥—Ä—É–≥–∏–µ –ø–æ–¥—Ö–æ–¥—ã:
```sql
-- –ß–∞—Å—Ç—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CDC + –±–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫—É)
-- –ö—Ä–∏—Ç–∏—á–µ–Ω —Å—Ç—Ä–æ–≥–∏–π –ø–æ—Ä—è–¥–æ–∫ —Å–æ–±—ã—Ç–∏–π 
-- –¢—Ä–µ–±—É—é—Ç—Å—è ACID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
-- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø—Ä–æ—Å—Ç–æ—Ç–µ –Ω–∞–¥ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å—é
```
–î–∞–Ω–Ω–∞—è –±–∞–∑–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ—Ç–ª–∏—á–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è 80% –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –≤—ã—Å–æ–∫—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –ø—Ä–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.

## 2. –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç–∏ Kafka –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Å —á–∞—Å—Ç—ã–º–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ –¥–∞–Ω–Ω—ã—Ö


## 2.1. –ü—Ä–æ–±–ª–µ–º–∞—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ –≤ ClickHouse
–û—Å–Ω–æ–≤–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:
```sql
-- –ù–ï–≠–§–§–ï–ö–¢–ò–í–ù–û: –ö–∞–∂–¥–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ü–µ–ª—ã–µ –≥—Ä–∞–Ω—É–ª—ã –¥–∞–Ω–Ω—ã—Ö
UPDATE products SET price = 150 WHERE product_id = 123;
```
–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤:
–ú–µ—Ç–æ–¥	–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å	–ù–∞–≥—Ä—É–∑–∫–∞ CPU	–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±—ä–µ–º–æ–≤
–¢–æ—á–µ—á–Ω—ã–µ UPDATE	~1,000 ops/sec	100%	–ù–∏–∑–∫–∞—è
–ë–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∞	~100,000 ops/sec	10-15%	–í—ã—Å–æ–∫–∞—è

## 2.2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è —Å Kafka

CDC (Change Data Capture) –ø–æ–¥—Ö–æ–¥
```
[OLTP –ë–î: PostgreSQL/MySQL] ‚Üí [Debezium CDC] ‚Üí [Kafka] ‚Üí [ClickHouse ReplacingMergeTree]
```
–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Kafka –≤ CDC:
  
  - ‚úÖ –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –ø–∏–∫–æ–≤ - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–ø–ª–µ—Å–∫–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
  - ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  - ‚úÖ –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å - –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Å–ª–µ —Å–±–æ–µ–≤
  - ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å - –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –∫–ª—é—á–∞–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ ClickHouse
```sql
-- –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –ø—Ä–∏–µ–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
CREATE TABLE products_changes (
    product_id UInt64,
    new_price Decimal32(2),
    operation Enum8('insert' = 1, 'update' = 2, 'delete' = 3),
    change_time DateTime,
    _version UInt64 MATERIALIZED toUnixTimestamp(change_time)
) ENGINE = ReplacingMergeTree(change_time)
ORDER BY (product_id, _version);

-- –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
CREATE MATERIALIZED VIEW products_mv TO products_changes AS
SELECT * FROM kafka_cdc_topic;
```
## 2.3. –ë–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∏:
```text
[OLTP –ë–î] ‚Üí [Debezium] ‚Üí [Kafka] ‚Üí [Staging Table] ‚Üí [–ë–∞—Ç—á-MERGE] ‚Üí [Final Table]
```
–ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è 10M+ –∑–∞–ø–∏—Å–µ–π:
  - üìä –û–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö: 2-4 GB –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –¥–µ–Ω—å
  - ‚ö° –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: 10-30 —Å–µ–∫—É–Ω–¥ –Ω–∞ —á–∞—Å –¥–∞–Ω–Ω—ã—Ö
  - ‚è±Ô∏è –ó–∞–¥–µ—Ä–∂–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏: 5-60 –º–∏–Ω—É—Ç
  - üíæ –ù–∞–≥—Ä—É–∑–∫–∞ CPU: 5-10% –≤–æ –≤—Ä–µ–º—è –±–∞—Ç—á–µ–π

–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –±–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∏:
   - üöÄ –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å - 100x —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ —Ç–æ—á–µ—á–Ω—ã—Ö UPDATE
   - üìà –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º–∏–ª–ª–∏–æ–Ω–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –¥–µ–Ω—å
   - üí° –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å - –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ ClickHouse
   - üï∞Ô∏è –ò—Å—Ç–æ—Ä–∏—á–Ω–æ—Å—Ç—å - –ø–æ–ª–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π

## 2.4. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
–ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è:
   - üè™ –ö–∞—Ç–∞–ª–æ–≥–∏ —Ç–æ–≤–∞—Ä–æ–≤ - —á–∞—Å—Ç—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω –∏ –Ω–∞–ª–∏—á–∏—è
   - üì¶ Inventory management - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–∞–º–∏
   - üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ - —á–∞—Å—Ç–æ –∏–∑–º–µ–Ω—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ
   - üìä –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã:
```sql
-- –ï–∂–µ—á–∞—Å–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
INSERT INTO products_final
SELECT 
    product_id,
    argMax(new_price, change_time) as current_price
FROM products_changes
WHERE change_time > now() - interval 1 hour
GROUP BY product_id;
```

## 2.5. –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã

Kafka + CDC - –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è:
   - üîÑ –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —á–∞—Å—Ç—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ ClickHouse
   - üìä –û–±—Ä–∞–±–æ—Ç–∫–∏ –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–∏–π
   - üõ°Ô∏è –û–±–µ—Å–ø–µ—á–µ–Ω–∏—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
   - ‚ö° –ü–æ–¥–¥–µ—Ä–∂–∫–∏ near real-time –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

–ë–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∞ —è–≤–ª—è–µ—Ç—Å—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º —Ä–∞–±–æ—Ç—ã —Å —á–∞—Å—Ç—ã–º–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ –≤ ClickHouse –Ω–∞ –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–∞—Ö –¥–∞–Ω–Ω—ã—Ö, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å.

–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤—è–∑–∫—É Debezium + Kafka + –±–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö —á–∞—Å—Ç—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö –≤ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ö—Ä–∞–Ω–∏–ª–∏—â–∞—Ö –Ω–∞ –æ—Å–Ω–æ–≤–µ ClickHouse.
